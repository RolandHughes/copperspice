Name:       @PACKAGE@
Version:    @RPM_VERSION@
Release:    @RPM_RELEASE@
Summary:    RedDiamond text editor
License:    GPL V2 + restriction
Group:      Applications/Editors
URL:        https://sourceforge.net/projects/reddiamond/
Vendor:     @CPACK_PACKAGE_VENDOR@
Packager:   Roland Hughes <roland@logikalsolutions.com>
Provides:   libCsCore1.7.so()(64bit), libCsGui1.7.so()(64bit), libCsNetwork1.7.so()(64bit)


%description
@REDDIAMOND_DESCRIPTION@

%prep
# Cleanup any left over build files
#
rm -rf *

# Populate the build directory
# -DENABLE_RPATH_ORIGIN=ON \
cmake -G "Ninja" -DCMAKE_BUILD_TYPE=Release \
      -DCMAKE_PREFIX_PATH="@CMAKE_PREFIX_PATH@" \
      -DCMAKE_INSTALL_PREFIX="%{buildroot}/opt/reddiamond" \
      "@CMAKE_SOURCE_DIR@"

%build
ninja

%install
# This variable gets rid of bogus RPATH error message
#
QA_RPATHS=\$[0x0003]
rm -rf %{buildroot}/opt/reddiamond
mkdir -p %{buildroot}/opt/reddiamond
mkdir -p %{buildroot}/usr/local/cs_lib/lib64
mkdir -p %{buildroot}/usr/local/lib/Lexilla
cp -Prv /usr/local/cs_lib/lib64/* %{buildroot}/usr/local/cs_lib/lib64/
cp -Prv /usr/local/lib/Lexilla/* %{buildroot}/usr/local/lib/Lexilla/
ninja install

%files
/opt/reddiamond
/usr/local/cs_lib
/usr/local/lib/Lexilla

%post
# no matter install or upgrade, create and copy
#
ln -s /opt/reddiamond/reddiamond /usr/local/bin
#
# We cannot use RPATH under Fedora and a few other RPM based distros
#
echo "/usr/local/cs_lib/lib64" > /etc/ld.so.conf.d/reddiamond_x86_64.conf
echo "/usr/local/lib/Lexilla" >> /etc/ld.so.conf.d/reddiamond_x86_64.conf
cp /opt/reddiamond/net.projects.reddiamond.desktop /usr/share/applications
cp /opt/reddiamond/reddiamond.png /usr/share/pixmaps
ldconfig


%postun
# No difference between upgrade and uninstall for these
#
rm /usr/local/bin/reddiamond
rm /usr/share/applications/net.projects.reddiamond.desktop
rm /usr/share/pixmaps/reddiamond.png

if [ $1 -gt 0 ] ; then
    # removing - need to completely remove the directory
    rm -rf /opt/reddiamond
    rm -rf /usr/local/cs_lib
    rm -rf /usr/local/lib/Lexilla
    rm /etc/ld.so.conf.d/reddiamond_x86_64.conf
    ldconfig
fi


%changelog
# let's skip this for now
